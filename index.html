<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>P2P Chat â€“ Simple Host/Guest</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:
    radial-gradient(circle at 10% 20%, #f97373 0, transparent 55%),
    radial-gradient(circle at 90% 80%, #1d2b64 0, transparent 55%),
    linear-gradient(145deg, #020617, #020617 40%, #020617 100%);
  padding: 16px 10px 24px;
  color: #e5e7eb;
  display: flex;
  align-items: stretch;
  justify-content: center;
}

.container {
  width: 100%;
  max-width: 480px;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚«ãƒ¼ãƒ‰å…±é€š â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  width: 100%;
  background: rgba(15, 23, 42, 0.9);
  border-radius: 24px;
  border: 1px solid rgba(148, 163, 184, 0.6);
  box-shadow: 0 20px 45px rgba(15, 23, 42, 0.9);
  backdrop-filter: blur(22px);
  padding: 18px 16px 16px;
  margin-bottom: 12px;
  animation: cardIn 0.35s ease-out;
}

@keyframes cardIn {
  from { opacity: 0; transform: translateY(14px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.hidden {
  display: none;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¿ã‚¤ãƒˆãƒ«è¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.title-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.title-icon {
  width: 26px;
  height: 26px;
  border-radius: 999px;
  background: conic-gradient(from 200deg, #f97373, #fb7185, #6366f1, #0ea5e9, #f97373);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.card h2 {
  margin: 0;
  font-size: 18px;
  letter-spacing: 0.03em;
}

.sub-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin: 6px 0 10px;
  padding: 5px 10px;
  border-radius: 999px;
  font-size: 11px;
  background: rgba(15, 118, 255, 0.16);
  border: 1px solid rgba(144, 202, 249, 0.4);
  color: #e5ecff;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœ€åˆã®é¸æŠç”»é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.role-card p {
  margin: 4px 0 8px;
  font-size: 12px;
  color: rgba(209, 213, 219, 0.9);
}

.role-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 4px;
}

.role-btn {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 11px 13px;
  border-radius: 16px;
  border: 1px solid rgba(148, 163, 184, 0.7);
  background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(37, 99, 235, 0.85));
  color: #f9fafb;
  text-align: left;
  cursor: pointer;
  box-shadow: 0 10px 22px rgba(15, 23, 42, 0.8);
  transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
}

.role-btn.secondary {
  background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(55, 65, 81, 0.9));
}

.role-btn:hover {
  filter: brightness(1.05);
  transform: translateY(-1px);
  box-shadow: 0 14px 28px rgba(15, 23, 42, 0.9);
}

.role-main {
  flex: 1;
}

.role-main .label {
  font-size: 12px;
  color: rgba(209, 213, 219, 0.95);
}

.role-main .desc {
  font-size: 11px;
  color: rgba(148, 163, 184, 0.95);
  margin-top: 2px;
}

.role-tag {
  padding: 3px 9px;
  border-radius: 999px;
  font-size: 11px;
  background: rgba(15, 23, 42, 0.92);
  border: 1px solid rgba(148, 163, 184, 0.85);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ‰‹é †è¡¨ç¤º â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.step {
  margin-top: 10px;
  padding: 8px 10px;
  border-radius: 14px;
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(55, 65, 81, 0.8);
}

.step-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.step-num {
  width: 18px;
  height: 18px;
  border-radius: 999px;
  background: rgba(37, 99, 235, 0.9);
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.step-title {
  font-size: 12px;
  font-weight: 600;
}

.step-body {
  font-size: 11px;
  color: rgba(209, 213, 219, 0.9);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…¥åŠ›ç³» â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
label.section-label {
  margin-top: 10px;
  display: block;
  font-size: 12px;
}

textarea,
input[type="text"] {
  width: 100%;
  margin-top: 4px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(148, 163, 184, 0.7);
  background: rgba(15, 23, 42, 0.92);
  color: #e5e7eb;
  font-size: 12px;
  resize: vertical;
}

textarea::placeholder,
input::placeholder {
  color: rgba(148, 163, 184, 0.9);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
  width: 100%;
  margin-top: 8px;
  padding: 10px 12px;
  border-radius: 14px;
  border: none;
  font-size: 14px;
  cursor: pointer;
  color: #f9fafb;
  background: linear-gradient(135deg, #4f46e5, #22d3ee);
  box-shadow: 0 8px 18px rgba(15, 23, 42, 0.7);
  transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
}

.btn:hover {
  filter: brightness(1.05);
  transform: translateY(-1px);
  box-shadow: 0 12px 24px rgba(15, 23, 42, 0.9);
}

.btn:active {
  transform: translateY(0);
  box-shadow: 0 5px 12px rgba(15, 23, 42, 0.7);
}

.btn-row {
  display: flex;
  gap: 6px;
  margin-top: 6px;
}

.btn-small {
  flex: 1;
  padding: 6px 8px;
  font-size: 11px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.92);
  border: 1px solid rgba(148, 163, 184, 0.75);
  box-shadow: none;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒãƒ£ãƒƒãƒˆç”»é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-text {
  font-size: 11px;
  color: rgba(209, 213, 219, 0.9);
  margin-top: 2px;
}

.chat-log {
  margin-top: 10px;
  padding: 8px;
  border-radius: 14px;
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(55, 65, 81, 0.9);
  min-height: 180px;
  max-height: 55vh;
  overflow-y: auto;
  font-size: 12px;
}

.msg {
  margin: 6px 0;
  padding: 7px 10px;
  border-radius: 14px;
  max-width: 80%;
  animation: msgIn 0.2s ease-out;
  word-wrap: break-word;
}

@keyframes msgIn {
  from { opacity: 0; transform: translateY(3px) scale(0.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.msg.me {
  margin-left: auto;
  background: linear-gradient(135deg, #4f46e5, #22d3ee);
  color: #f9fafb;
}

.msg.other {
  background: rgba(15, 23, 42, 0.98);
  border: 1px solid rgba(75, 85, 99, 0.9);
}

.msg.system {
  margin: 4px auto;
  text-align: center;
  font-size: 10px;
  color: rgba(148, 163, 184, 0.95);
  background: transparent;
}

.chat-input-row {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

#msgInput {
  flex: 1;
  max-height: 90px;
}

.send-btn {
  width: 86px;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒ¡ãƒ‡ã‚£ã‚¢èª¿æ•´ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (min-width: 768px) {
  body {
    padding: 20px;
    align-items: center;
  }
}
</style>
</head>
<body>
<div class="container">

  <!-- â‘  å½¹å‰²é¸æŠç”»é¢ -->
  <div class="card role-card" id="screenSelect">
    <div class="title-row">
      <div class="title-icon">ğŸ’¬</div>
      <h2>P2P Chat</h2>
    </div>
    <div class="sub-pill">ã‚µãƒ¼ãƒãƒ¼ã«å±¥æ­´ã‚’æ®‹ã•ãšã€ãƒ–ãƒ©ã‚¦ã‚¶åŒå£«ã§ç›´æ¥é€šä¿¡</div>
    <p>2äººã§ä½¿ã†æƒ³å®šã§ã™ã€‚åŒã˜æ™‚é–“ã«ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã€ã©ã¡ã‚‰ã‹ä¸€æ–¹ãŒã€ŒAã•ã‚“ï¼ˆå…ˆã«ã¯ã˜ã‚ã‚‹ï¼‰ã€ã€ã‚‚ã†ä¸€æ–¹ãŒã€ŒBã•ã‚“ï¼ˆã‚ã¨ã‹ã‚‰å…¥ã‚‹ï¼‰ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>

    <div class="role-buttons">
      <button class="role-btn" onclick="selectRole('host')">
        <div class="role-main">
          <div class="label">Aã•ã‚“ï¼ˆå…ˆã«ã¯ã˜ã‚ã‚‹äººï¼‰</div>
          <div class="desc">å…ˆã«æ¥ç¶šã®æº–å‚™ã‚’ã™ã‚‹äººã¯ã“ã¡ã‚‰ã€‚å‡ºã¦ããŸã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«é€ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="role-tag">ãƒ›ã‚¹ãƒˆå´</div>
      </button>

      <button class="role-btn secondary" onclick="selectRole('guest')">
        <div class="role-main">
          <div class="label">Bã•ã‚“ï¼ˆã‚ã¨ã‹ã‚‰å…¥ã‚‹äººï¼‰</div>
          <div class="desc">Aã•ã‚“ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸã‚³ãƒ¼ãƒ‰ã‚’è²¼ã£ã¦æ¥ç¶šã—ã¾ã™ã€‚</div>
        </div>
        <div class="role-tag">ã‚²ã‚¹ãƒˆå´</div>
      </button>
    </div>
  </div>

  <!-- â‘¡ ãƒ›ã‚¹ãƒˆç”»é¢ï¼ˆAã•ã‚“ï¼‰ -->
  <div class="card hidden" id="screenHost">
    <div class="title-row">
      <div class="title-icon">ğŸ›°</div>
      <h2>Aã•ã‚“ã®ç”»é¢ï¼ˆãƒ›ã‚¹ãƒˆï¼‰</h2>
    </div>
    <div class="sub-pill">å…ˆã«æ¥ç¶šã‚’å§‹ã‚ã‚‹äººç”¨ã®æ‰‹é †ã§ã™</div>

    <div class="step">
      <div class="step-header">
        <div class="step-num">â‘ </div>
        <div class="step-title">æ¥ç¶šã‚³ãƒ¼ãƒ‰ï¼ˆOfferï¼‰ã‚’ä½œã‚‹</div>
      </div>
      <div class="step-body">
        ã€Œæ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚æ•°ç§’ã™ã‚‹ã¨ã€ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆæ¬„ã«é•·ã„æ–‡å­—åˆ—ãŒå‡ºã¾ã™ã€‚
        ãã‚Œã‚’<span style="font-weight:600;">Bã•ã‚“ã«ã‚³ãƒ”ãƒ¼ã—ã¦é€ã£ã¦</span>ãã ã•ã„ã€‚
      </div>
    </div>

    <button class="btn" id="btnCreateOffer">æ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆAã•ã‚“ç”¨ï¼‰</button>
    <label class="section-label" for="offerText">Aã•ã‚“ã®æ¥ç¶šã‚³ãƒ¼ãƒ‰ï¼ˆOfferï¼‰</label>
    <textarea id="offerText" rows="4" placeholder="ã“ã“ã«Aã•ã‚“ã®æ¥ç¶šã‚³ãƒ¼ãƒ‰ï¼ˆOfferï¼‰ãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™"></textarea>
    <div class="btn-row">
      <button class="btn btn-small" type="button" onclick="copyText('offerText')">Offerã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Bã•ã‚“ã«é€ã‚‹</button>
    </div>

    <div class="step" style="margin-top:12px;">
      <div class="step-header">
        <div class="step-num">â‘¡</div>
        <div class="step-title">Bã•ã‚“ã‹ã‚‰å±Šã„ãŸ Answer ã‚’è²¼ã‚‹</div>
      </div>
      <div class="step-body">
        Bã•ã‚“å´ã§ç”Ÿæˆã•ã‚ŒãŸã€ŒAnswerã€ã¨ã„ã†ã‚³ãƒ¼ãƒ‰ãŒé€ã‚‰ã‚Œã¦ããŸã‚‰ã€ä¸‹ã®æ¬„ã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
      </div>
    </div>

    <label class="section-label" for="hostAnswerText">Bã•ã‚“ã‹ã‚‰ã®Answer</label>
    <textarea id="hostAnswerText" rows="4" placeholder="Bã•ã‚“ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸAnswerã‚’ã“ã“ã«è²¼ã‚‹"></textarea>
    <div class="btn-row">
      <button class="btn btn-small" type="button" onclick="pasteText('hostAnswerText')">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘</button>
      <button class="btn btn-small" type="button" id="btnApplyAnswer">Answerã‚’é©ç”¨ã—ã¦æ¥ç¶š</button>
    </div>
    <div class="status-text" id="hostStatus">ã¾ã æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
  </div>

  <!-- â‘¢ ã‚²ã‚¹ãƒˆç”»é¢ï¼ˆBã•ã‚“ï¼‰ -->
  <div class="card hidden" id="screenGuest">
    <div class="title-row">
      <div class="title-icon">ğŸ“¡</div>
      <h2>Bã•ã‚“ã®ç”»é¢ï¼ˆã‚²ã‚¹ãƒˆï¼‰</h2>
    </div>
    <div class="sub-pill">ã‚ã¨ã‹ã‚‰æ¥ç¶šã«å‚åŠ ã™ã‚‹äººç”¨ã®æ‰‹é †ã§ã™</div>

    <div class="step">
      <div class="step-header">
        <div class="step-num">â‘ </div>
        <div class="step-title">Aã•ã‚“ã®æ¥ç¶šã‚³ãƒ¼ãƒ‰ï¼ˆOfferï¼‰ã‚’è²¼ã‚‹</div>
      </div>
      <div class="step-body">
        Aã•ã‚“ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸé•·ã„ã‚³ãƒ¼ãƒ‰ï¼ˆOfferï¼‰ã‚’ã€ä¸‹ã®æ¬„ã«ä¸¸ã”ã¨è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
      </div>
    </div>

    <label class="section-label" for="guestOfferText">Aã•ã‚“ã®Offer</label>
    <textarea id="guestOfferText" rows="4" placeholder="Aã•ã‚“ã‹ã‚‰é€ã‚‰ã‚ŒãŸOfferã‚’ã“ã“ã«è²¼ã‚‹"></textarea>
    <div class="btn-row">
      <button class="btn btn-small" type="button" onclick="pasteText('guestOfferText')">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘</button>
    </div>

    <div class="step" style="margin-top:12px;">
      <div class="step-header">
        <div class="step-num">â‘¡</div>
        <div class="step-title">Answerã‚’ä½œã£ã¦Aã•ã‚“ã«è¿”ã™</div>
      </div>
      <div class="step-body">
        ã€ŒAnswerã‚’ä½œæˆã€ã‚’æŠ¼ã™ã¨ã€ä¸‹ã®æ¬„ã«Bã•ã‚“ã®AnswerãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
        ãã‚Œã‚’<span style="font-weight:600;">Aã•ã‚“ã«ã‚³ãƒ”ãƒ¼ã—ã¦é€ã£ã¦</span>ãã ã•ã„ã€‚
      </div>
    </div>

    <button class="btn" id="btnCreateAnswer">Answerã‚’ä½œæˆï¼ˆBã•ã‚“ç”¨ï¼‰</button>
    <label class="section-label" for="guestAnswerOut">Bã•ã‚“ã®Answer</label>
    <textarea id="guestAnswerOut" rows="4" placeholder="ã“ã“ã«Bã•ã‚“ã®AnswerãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™"></textarea>
    <div class="btn-row">
      <button class="btn btn-small" type="button" onclick="copyText('guestAnswerOut')">Answerã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Aã•ã‚“ã«é€ã‚‹</button>
    </div>
    <div class="status-text" id="guestStatus">ã¾ã æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
  </div>

  <!-- â‘£ ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
  <div class="card hidden" id="screenChat">
    <div class="title-row">
      <div class="title-icon">âœ¨</div>
      <h2>ãƒãƒ£ãƒƒãƒˆ</h2>
    </div>
    <div class="sub-pill" id="chatStatus">æ¥ç¶šã‚’å¾…æ©Ÿä¸­â€¦</div>

    <div class="chat-log" id="chatLog"></div>

    <div class="chat-input-row">
      <textarea id="msgInput" rows="2" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆEnterã§é€ä¿¡ã€Shift+Enterã§æ”¹è¡Œï¼‰"></textarea>
      <button class="btn send-btn" id="btnSend">é€ä¿¡</button>
    </div>
  </div>

</div>

<script>
let pc = null;
let channel = null;
let currentRole = null; // 'host' or 'guest'

/* ===== DOMå–å¾— ===== */
const screenSelect = document.getElementById("screenSelect");
const screenHost   = document.getElementById("screenHost");
const screenGuest  = document.getElementById("screenGuest");
const screenChat   = document.getElementById("screenChat");

const hostStatus  = document.getElementById("hostStatus");
const guestStatus = document.getElementById("guestStatus");
const chatStatus  = document.getElementById("chatStatus");

const offerText        = document.getElementById("offerText");
const hostAnswerText   = document.getElementById("hostAnswerText");
const guestOfferText   = document.getElementById("guestOfferText");
const guestAnswerOut   = document.getElementById("guestAnswerOut");
const chatLog          = document.getElementById("chatLog");
const msgInput         = document.getElementById("msgInput");
const btnSend          = document.getElementById("btnSend");

/* ãƒœã‚¿ãƒ³ */
const btnCreateOffer  = document.getElementById("btnCreateOffer");
const btnApplyAnswer  = document.getElementById("btnApplyAnswer");
const btnCreateAnswer = document.getElementById("btnCreateAnswer");

/* ===== å½¹å‰²é¸æŠ ===== */
function selectRole(role) {
  currentRole = role;
  screenSelect.classList.add("hidden");
  initRTC();

  if (role === "host") {
    screenHost.classList.remove("hidden");
  } else {
    screenGuest.classList.remove("hidden");
  }
}

/* ===== WebRTCåˆæœŸåŒ– ===== */
function initRTC() {
  const config = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  };
  pc = new RTCPeerConnection(config);

  pc.onconnectionstatechange = () => {
    const st = pc.connectionState;
    console.log("connectionState =", st);
    if (st === "connected") {
      chatStatus.textContent = "æ¥ç¶šå®Œäº†";
      addMsg("æ¥ç¶šã—ã¾ã—ãŸ", "system");
    } else if (st === "disconnected" || st === "failed" || st === "closed") {
      chatStatus.textContent = "åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ";
      addMsg("æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ", "system");
    }
  };

  // ã‚²ã‚¹ãƒˆå´ã¯ç›¸æ‰‹ã‹ã‚‰DataChannelãŒé€ã‚‰ã‚Œã¦ãã‚‹
  pc.ondatachannel = event => {
    channel = event.channel;
    setupDataChannel();
  };
}

/* ãƒ›ã‚¹ãƒˆå´ DataChannel ä½œæˆ */
function createHostChannel() {
  channel = pc.createDataChannel("chat");
  setupDataChannel();
}

/* DataChannel å…±é€šè¨­å®š */
function setupDataChannel() {
  channel.onopen = () => {
    console.log("DataChannel open");
    screenChat.classList.remove("hidden");
  };
  channel.onclose = () => {
    console.log("DataChannel closed");
    addMsg("ãƒãƒ£ãƒãƒ«ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ", "system");
  };
  channel.onerror = (e) => {
    console.error("DataChannel error", e);
    addMsg("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "system");
  };
  channel.onmessage = (event) => {
    addMsg(String(event.data), "other");
  };
}

/* ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º ===== */
function addMsg(text, type) {
  const div = document.createElement("div");
  div.className =
    type === "me" ? "msg me" :
    type === "other" ? "msg other" : "msg system";
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

/* ===== ã‚³ãƒ”ãƒ¼ï¼ãƒšãƒ¼ã‚¹ãƒˆ ===== */
function copyText(id) {
  const el = document.getElementById(id);
  el.select();
  try {
    document.execCommand("copy");
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  } catch {
    alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
  }
}

function pasteText(id) {
  const el = document.getElementById(id);
  if (!navigator.clipboard) {
    alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆã¾ã›ã‚“ã€‚æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
    return;
  }
  navigator.clipboard.readText().then(text => {
    el.value = text;
  }).catch(() => {
    alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
  });
}

/* ===== ãƒ›ã‚¹ãƒˆå´ï¼šOfferç”Ÿæˆ ===== */
btnCreateOffer.onclick = async () => {
  if (!pc) initRTC();
  createHostChannel();

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  hostStatus.textContent = "æ¥ç¶šã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆä¸­â€¦ï¼ˆæ•°ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰";

  pc.onicecandidate = e => {
    if (!e.candidate) {
      // ã™ã¹ã¦ã®ICEå€™è£œãŒé›†ã¾ã£ãŸ
      offerText.value = JSON.stringify(pc.localDescription);
      hostStatus.textContent = "OfferãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚Bã•ã‚“ã«é€ã£ã¦ãã ã•ã„ã€‚";
    }
  };
};

/* ãƒ›ã‚¹ãƒˆå´ï¼šAnsweré©ç”¨ */
btnApplyAnswer.onclick = async () => {
  const txt = hostAnswerText.value.trim();
  if (!txt) {
    alert("Bã•ã‚“ã‹ã‚‰ã®Answerã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
    return;
  }
  try {
    const ans = JSON.parse(txt);
    await pc.setRemoteDescription(ans);
    hostStatus.textContent = "Answerã‚’é©ç”¨ã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’å¾…æ©Ÿä¸­â€¦";
    screenChat.classList.remove("hidden");
  } catch (e) {
    console.error(e);
    alert("Answerã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ã‚³ãƒ”ãƒ¼æ¼ã‚Œã‚„é€”ä¸­ã§åˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
};

/* ===== ã‚²ã‚¹ãƒˆå´ï¼šAnswerç”Ÿæˆ ===== */
btnCreateAnswer.onclick = async () => {
  const txt = guestOfferText.value.trim();
  if (!txt) {
    alert("Aã•ã‚“ã‹ã‚‰ã®Offerã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
    return;
  }
  try {
    const offer = JSON.parse(txt);
    await pc.setRemoteDescription(offer);

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    guestStatus.textContent = "Answerã‚’ä½œæˆä¸­â€¦ï¼ˆæ•°ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰";

    pc.onicecandidate = e => {
      if (!e.candidate) {
        guestAnswerOut.value = JSON.stringify(pc.localDescription);
        guestStatus.textContent = "AnswerãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚Aã•ã‚“ã«é€ã£ã¦ãã ã•ã„ã€‚";
        screenChat.classList.remove("hidden");
      }
    };
  } catch (e) {
    console.error(e);
    alert("Offerã®å½¢å¼ãŒä¸æ­£ã§ã™ã€‚ã‚³ãƒ”ãƒ¼æ¼ã‚Œã‚„é€”ä¸­ã§åˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
};

/* ===== ãƒãƒ£ãƒƒãƒˆé€ä¿¡ ===== */
btnSend.onclick = () => {
  const text = msgInput.value.trim();
  if (!text) return;
  if (!channel || channel.readyState !== "open") {
    alert("ã¾ã æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Aã•ã‚“ãƒ»Bã•ã‚“ã®æ‰‹é †ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  channel.send(text);
  addMsg(text, "me");
  msgInput.value = "";
};

msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    btnSend.click();
  }
});
</script>
</body>
</html>
